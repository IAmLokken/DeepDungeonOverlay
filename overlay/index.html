<html>
<head>
    <meta charset="utf-8" />
    <title>Deep Dungeon Overlay</title>
    <link rel="stylesheet" href="css/display.css" />    

    <script src="https://ngld.github.io/OverlayPlugin/assets/shared/common.min.js"></script>
    <script src="lib/DDO.js"></script>
    <script src="lib/Locale.js"></script>
    <script src="lib/Beastiary.js"></script>
    <script src="lib/Parser.js"></script>
    <script src="lib/Calculator.js"></script>

    <script>

        document.addEventListener("onOverlayStateUpdate", function (e) {
            if (!e.detail.isLocked) {
                displayResizeHandle();
            } else {
                hideResizeHandle();
            }
        });        
        function displayResizeHandle() {
            document.documentElement.classList.add("resizeHandle");
        }
        function hideResizeHandle() {
            document.documentElement.classList.remove("resizeHandle");
        } 

        window.addEventListener("load", (e) => {
            LoadData();
        });
        async function LoadData()
        {
            PopulateDataElements();

            var loadedSaveFiles = await callOverlayHandler({call: "loadData", key: "DDO_Saves"}); 
            if (loadedSaveFiles && !loadedSaveFiles.$isNull){
                DDO.SaveFiles = JSON.parse(loadedSaveFiles.data);
            }

            var config = await callOverlayHandler({call: "loadData", key: "DDO_Config"});
            if (config && config.$isNull){
                await DDO.SetDefaultConfig();
            }
            else{
                 DDO.Config = JSON.parse(config.data);
            }            

            var displayOverlayLanguage;
            displayOverlayLanguage = await callOverlayHandler({call: "getLanguage"});
            
            var displayOverlayLocale = 'en';
            switch(displayOverlayLanguage)
            {
                case 'English':
                    displayOverlayLocale = 'en';
                    break;
                default:
                    break;
            }

            await DDO.LoadBeastiary(displayOverlayLocale);
            
            DDO.localeInformation = new DDO.Locale(displayOverlayLocale, (e) => 
            {
                DDO.TranslateUI(e);
                DDO.LoadConfig(DDO.currentInstance);
                startOverlayEvents();
            });
        }
        
        addOverlayListener("LogLine", (e) => LogLine(e));
        addOverlayListener("ChangeZone", (e) => ChangeZone(e));
        addOverlayListener("PartyChanged", (e) => PartyChanged(e));
        addOverlayListener("EnmityTargetData", (e) => EnmityTargetData(e));
        addOverlayListener("ChangePrimaryPlayer", (e) => ChangePrimaryPlayer(e));        

        function LogLine(data)
        {
            if (DDO.soloRunUnderway && 
                !DDO.inbetweenArea && 
                DDO.ParsedLogNumbers.includes(data.line[0]))
            {
                DDO.ProcessLogLine(data);
            }
            else if(DDO.groupRunUnderway && 
                    !DDO.inbetweenArea && 
                    data.line[0] == '00' &&
                    data.rawLine.includes(DDO.localeInformation.Languages[localeInformation.CurrentLanguage].ParseStrings['Transference']))
            {
                DDO.currentFloor++;
            }
            else if ((data.line[0] == '03' || data.line[0] == '12') && 
                    data.rawLine.includes(DDO.playerName))
            {
                DDO.UpdatePlayerInfo();
            }
        }
        function ChangeZone(data)
        {
            console.log(data);
            DDO.LoadConfig(data.zoneName);
        }
        function ChangePrimaryPlayer(data)
        {
            DDO.playerName = data.charName;
            DDO.UpdatePlayerInfo();
        }
        function PartyChanged(data)
        {
            console.log("Party Changed");
            console.log(data);
            DDO.isInGroup = data.party.length > 1;
        }
        function EnmityTargetData(data)
        {
            if (data.Target != null && (DDO.currentInstance == 'the Palace of the Dead' || DDO.currentInstance == 'Heaven-on-High') && !DDO.inbetweenArea){
                DDO.DisplayTargetInfo(data);
            }
            else{
                DDO.ClearTargetInfo();
            }
        } 

        function PopulateDataElements()
        {
            DDO.DataElements.POTDButton = document.getElementById("POTDButton");
            DDO.DataElements.HOHButton = document.getElementById("HOHButton");

            DDO.DataElements.ScoreValue = document.getElementById("Score");
            DDO.DataElements.MonstersFloorValue = document.getElementById("MonstersFloor");
            DDO.DataElements.MonstersSetValue = document.getElementById("MonstersSet");
            DDO.DataElements.MonstersTotalValue = document.getElementById("MonstersTotal");

            DDO.DataElements.MimicsFloorValue = document.getElementById("MimicsFloor");
            DDO.DataElements.MimicsSetValue = document.getElementById("MimicsSet");
            DDO.DataElements.MimicsTotalValue = document.getElementById("MimicsTotal");

            DDO.DataElements.TrapsFloorValue = document.getElementById("TrapsFloor");
            DDO.DataElements.TrapsSetValue = document.getElementById("TrapsSet");
            DDO.DataElements.TrapsTotalValue = document.getElementById("TrapsTotal");

            DDO.DataElements.ChestsFloorValue = document.getElementById("ChestsFloor");
            DDO.DataElements.ChestsSetValue = document.getElementById("ChestsSet");
            DDO.DataElements.ChestsTotalValue = document.getElementById("ChestsTotal");

            DDO.DataElements.EnchantmentsFloorValue = document.getElementById("EnchantmentsFloor");
            DDO.DataElements.EnchantmentsSetValue = document.getElementById("EnchantmentsSet");
            DDO.DataElements.EnchantmentsTotalValue = document.getElementById("EnchantmentsTotal");

            DDO.DataElements.RareMonstersFloorValue = document.getElementById("RareMonstersFloor");
            DDO.DataElements.RareMonstersSetValue = document.getElementById("RareMonstersSet");
            DDO.DataElements.RareMonstersTotalValue = document.getElementById("RareMonstersTotal");

            DDO.DataElements.SpeedRunsFloorValue = document.getElementById("SpeedRunsFloor");
            DDO.DataElements.SpeedRunsSetValue = document.getElementById("SpeedRunsSet");
            DDO.DataElements.SpeedRunsTotalValue = document.getElementById("SpeedRunsTotal");

            DDO.DataElements.TargetNameValue = document.getElementById("TargetName");
            DDO.DataElements.TargetHPPValue = document.getElementById("TargetHPP");
            DDO.DataElements.DangerEasyImage = document.getElementById("DangerEasy");
            DDO.DataElements.DangerCautionImage = document.getElementById("DangerCaution");
            DDO.DataElements.DangerScaryImage = document.getElementById("DangerScary");
            DDO.DataElements.DangerImpossibleImage = document.getElementById("DangerImpossible");
            DDO.DataElements.AggroSightImage = document.getElementById("AggroSight");
            DDO.DataElements.AggroSoundImage = document.getElementById("AggroSound");
            DDO.DataElements.AggroProximityImage = document.getElementById("AggroProximity");

            DDO.DataElements.BeastiaryCheckBoxValue = document.getElementById("CheckBoxBestiary");
            DDO.DataElements.StatisticsCheckBoxValue = document.getElementById("CheckBoxStatistics");
            DDO.DataElements.PomandersCheckBoxValue = document.getElementById("CheckBoxPomanders");
            DDO.DataElements.ScoreCheckBoxValue = document.getElementById("CheckBoxScore");

            DDO.DataElements.PomSafetyDisabledImage = document.getElementById("PomSafetyDisabled");
            DDO.DataElements.PomSightDisabledImage = document.getElementById("PomSightDisabled");
            DDO.DataElements.PomAffluenceDisabledImage = document.getElementById("PomAffluenceDisabled");
            DDO.DataElements.PomAlterationDisabledImage = document.getElementById("PomAlterationDisabled");
            DDO.DataElements.PomFlightDisabledImage = document.getElementById("PomFlightDisabled");

            DDO.DataElements.PomSafetyEnabledImage = document.getElementById("PomSafetyEnabled");
            DDO.DataElements.PomSightEnabledImage = document.getElementById("PomSightEnabled");
            DDO.DataElements.PomAffluenceEnabledImage = document.getElementById("PomAffluenceEnabled");
            DDO.DataElements.PomAlterationEnabledImage = document.getElementById("PomAlterationEnabled");
            DDO.DataElements.PomFlightEnabledImage = document.getElementById("PomFlightEnabled");            
        }

    </script>
</head>
<body>
    <div id="mainBody">
    <div id="header">
        Deep Dungeon Overlay
        <span id="config">
            <input type="checkbox" id="CheckBoxBestiary" style="float:right;" onchange="DDO.EnableDisableElement(checked, 'targetinfo', true)"  />
            <input type="checkbox" id="CheckBoxStatistics" style="float:right;" onchange="DDO.EnableDisableElement(checked, 'statistics', true)"  />
            <input type="checkbox" id="CheckBoxPomanders" style="float:right;" onchange="DDO.EnableDisableElement(checked, 'pomanders', true)"  />
            <input type="checkbox" id="CheckBoxScore" style="float:right;" onchange="DDO.EnableDisableElement(checked, 'score', true)"  />
        </span>
    </div>
    <hr color="black">
    
    <div id="saveManager">
        <button type="button" id="POTDButton" class="Translate" onclick="DDO.ClearPOTDSaves()"></button>
        <button type="button" id="HOHButton" class="Translate" onclick="DDO.ClearHOHSaves()"></button>
    </div>
    
    <table id="score" style="padding-bottom:5px">
        <tr>
            <td id="ScoreLabel" class="Translate" style="white-space:nowrap; font-size: 25px;" width="25%">-</td>
            <td id="Score" style="font-size: 35px; padding-left:10px;" width="75%">1,349,982</td>
        </tr>
    </table>

    <table id="pomanders" width="100%" style="padding-bottom:5px">
        <tr>
            <td id="PomSafety" style="width:20%; text-align:center"><img id="PomSafetyDisabled" src="../img/PomSafetyDisabled.png" /><img id="PomSafetyEnabled" style = "display:none;" src="../img/PomSafetyEnabled.png" /></td>
            <td id="PomSight" style="width:20%; text-align:center"><img id="PomSightDisabled" src="../img/PomSightDisabled.png" /><img id="PomSightEnabled" style = "display:none;" src="../img/PomSightEnabled.png" /></td>
            <td id="PomAffluence" style="width:20%; text-align:center"><img id="PomAffluenceDisabled" src="../img/PomAffluenceDisabled.png" /><img id="PomAffluenceEnabled" style = "display:none;" src="../img/PomAffluenceEnabled.png" /></td>
            <td id="PomAlteration" style="width:20%; text-align:center"><img id="PomAlterationDisabled" src="../img/PomAlterationDisabled.png" /><img id="PomAlterationEnabled" style = "display:none;" src="../img/PomAlterationEnabled.png" /></td>
            <td id="PomFlight" style="width:20%; text-align:center"><img id="PomFlightDisabled"src="../img/PomFlightDisabled.png" /><img id="PomFlightEnabled" style = "display:none;" src="../img/PomFlightEnabled.png" /></td>
        </tr>
    </table>

    <table id="statistics">
        <tr style="text-align:right;">
            <th></th>
            <th id="FloorLabel" class="Translate" scope="col">-</th>
            <th id="SetLabel" class="Translate" scope="col">-</th>
            <th id="TotalLabel" class="Translate" scope="col">-</th>
        </tr>
        <tr style="text-align:right;">
            <th id="MonstersLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="MonstersFloor">5</td>
            <td id="MonstersSet">56</td>
            <td id="MonstersTotal">368</td>
        </tr>
        <tr style="text-align:right;">
            <th id="MimicsLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="MimicsFloor">1(0)</td>
            <td id="MimicsSet">4(2)</td>
            <td id="MimicsTotal">18(4)</td>
        </tr>
        <tr style="text-align:right;">
            <th id="TrapsLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="TrapsFloor">0</td>
            <td id="TrapsSet">3</td>
            <td id="TrapsTotal">8</td>
        </tr>
        <tr style="text-align:right;">
            <th id="ChestsLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="ChestsFloor">3</td>
            <td id="ChestsSet">15</td>
            <td id="ChestsTotal">125</td>
        </tr>
        <tr style="text-align:right;">
            <th id="EnchantmentsLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="EnchantmentsFloor">2</td>
            <td id="EnchantmentsSet">5</td>
            <td id="EnchantmentsTotal">32</td>
        </tr>
        <tr style="text-align:right;">
            <th id="RareMonstersLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="RareMonstersFloor">1</td>
            <td id="RareMonstersSet">0</td>
            <td id="RareMonstersTotal">3</td>
        </tr>
        <tr style="text-align:right;">
            <th id="SpeedRunsLabel" class="Translate" scope="row" style="text-align:left;">-</th>
            <td id="SpeedRunsFloor">-</td>
            <td id="SpeedRunsSet">-</td>
            <td id="SpeedRunsTotal">4</td>
        </tr>
    </table>
    <br>
    <table id="targetinfo">
        <tr>
            <td id="TargetName" class="Beastiary">-</td>
            <td id="TargetHPP">-</td>
            <td id="DangerLevel"><img id = "DangerEasy" style="display: none;" src="../img/Easy.png" /><img id = "DangerCaution" style="display: none;" src="../img/Caution.png" /><img id = "DangerScary" style="display: none;" src="../img/Scary.png" /><img id = "DangerImpossible" style="display: none;" src="../img/Impossible.png" /></td>
            <td id="AggroType"><img id = "AggroSight" style="display: none;" src="../img/Sight.png" /><img id = "AggroSound" style="display: none;" src="../img/Sound.png" /><img id = "AggroProximity" style="display: none;" src="../img/Proximity.png" /></td>
        </tr>
        <tr>
            <td id="TargetInformation" class="Beastiary" colSpan = 4 style="padding: 4px; text-align:left; background:rgb(0, 0, 70);">-</td>
        </tr>
    </table>

    <div id="scoreDebug">
        <button type="button" id="scoreDebugButton" onclick="DDO.CalculateScoreNoRoomReveal()">Calculate Score</button>
        <br/>
        <span id="debugScore" style="color: seashell;">-</span>
    </div>
</div>
</body>
</html>